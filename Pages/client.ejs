<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticação SED</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <main class="login">
        <div class="login-container">
            <div class="login-header">
                <img class="logo-img" src="/assets/logo-sed.png" alt="Logo SED">
                <h1>Autenticação SED</h1>
            </div>

            <form id="login-form" class="login-form">
                <div class="login-form-group">
                    <label for="ra">RA</label>
                    <input id="ra" name="ra" required>
                </div>
                <div class="login-form-group">
                    <label for="digit">Dígito</label>
                    <input id="digit" name="digit" required>
                </div>
                <div class="login-form-group">
                    <label for="uf">UF</label>
                    <select id="uf" name="uf" required>
                        <option value="">Selecione o estado</option>
                        <option value="SP">SP</option>
                        <option value="AC">AC</option>
                        <option value="AL">AL</option>
                        <option value="AP">AP</option>
                        <option value="AM">AM</option>
                        <option value="BA">BA</option>
                        <option value="CE">CE</option>
                        <option value="DF">DF</option>
                        <option value="ES">ES</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="MT">MT</option>
                        <option value="MS">MS</option>
                        <option value="MG">MG</option>
                        <option value="PA">PA</option>
                        <option value="PB">PB</option>
                        <option value="PR">PR</option>
                        <option value="PE">PE</option>
                        <option value="PI">PI</option>
                        <option value="RJ">RJ</option>
                        <option value="RN">RN</option>
                        <option value="RS">RS</option>
                        <option value="RO">RO</option>
                        <option value="RR">RR</option>
                        <option value="SC">SC</option>
                        <option value="SE">SE</option>
                        <option value="TO">TO</option>
                    </select>
                </div>
                <div class="login-form-group">
                    <label for="password">Senha</label>
                    <input id="password" name="password" type="password" required>
                </div>
                <button type="submit" class="login-btn">Entrar</button>
            </form>

            <div id="error" class="login-error"></div>
        </div>
    </main>

    <script>
        const loginForm = document.getElementById('login-form');
        const errorBox = document.getElementById('error');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const ra = loginForm.ra.value;
            const digit = loginForm.digit.value;
            const uf = loginForm.uf.value;
            const password = loginForm.password.value;

            await sedLogin(ra, digit, uf, password);
        });

        function showError(message) {
            errorBox.innerText = message;
            errorBox.style.display = 'block';
        }

        async function sedLogin(ra, digit, uf, password) {
            const loginBtn = loginForm.querySelector('button');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Autenticando...';

            try {
                const sedLoginResponse = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: '<%= client.clientTargetPlatform %>',
                        ra,
                        digit,
                        uf,
                        password
                    })
                });

                if (!sedLoginResponse.ok) {
                    throw new Error(`Erro ${sedLoginResponse.status} ao autenticar`);
                }

                const sedLoginJson = await sedLoginResponse.json();
                const token = sedLoginJson.token;
                const success = token && !token.includes(btoa('null'));

                if (success) {
                    const redirParam = '<%= client.clientRedir %>';
                    if (redirParam) {
                        try {
                            const targetRedir = new URL(decodeURIComponent(redirParam));
                            targetRedir.searchParams.append('sdf_token', token);
                            window.location.href = targetRedir.toString();
                            return;
                        } catch (err) {
                            console.error("Erro ao redirecionar:", err);
                        }
                    }
                    // fallback
                    location.href = 'https://saladofuturo.educacao.sp.gov.br/';
                } else {
                    showError('Credenciais inválidas. Por favor, tente novamente.');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Entrar';
                }

            } catch (err) {
                console.error('Erro na autenticação:', err);
                showError('Erro no servidor. Tente novamente mais tarde.');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }
    </script>
</body>
</html>
